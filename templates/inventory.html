<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Rent-a-Gear Inventory</title>

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=cancel,check_circle,edit"
    />

    <style>
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
      }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{{ url_for('static', filename='tailwind.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts.js') }}"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        let editingField = null;

        document.querySelectorAll(".group").forEach((container) => {
          const fieldValueDiv = container.querySelector(".field-value");
          const editBtn = container.querySelector(".edit-btn");
          const confirmBtn = container.querySelector(".confirm-btn");
          const cancelBtn = container.querySelector(".cancel-btn");
          const itemId = container.dataset.item;
          const field = container.dataset.field;

          let oldValue = ""; // Moved this declaration here

          editBtn.addEventListener("click", async () => {
            if (editingField) return; // only one editable field at a time
            editingField = container;

            oldValue = fieldValueDiv.textContent.trim(); // Store old value on edit

            // Replace the field's text with an input
            fieldValueDiv.innerHTML = `<input type="text" value="${oldValue}" class="border rounded px-1 py-0.5 w-3/4 text-sm mr-2">`;

            // Hide the edit button and show the confirm/cancel buttons
            editBtn.classList.add("hidden");
            confirmBtn.classList.remove("hidden");
            cancelBtn.classList.remove("hidden");
          });

          confirmBtn.addEventListener("click", async () => {
            const newValue = fieldValueDiv.querySelector("input").value.trim();

            // POST to /inventory/edit
            const formData = new FormData();
            formData.append("itemId", itemId);
            formData.append("field", field);
            formData.append("newValue", newValue);

            const res = await fetch("/inventory/edit", {
              method: "POST",
              body: formData,
            });

            if (!res.ok) {
              const text = await res.text();
              alert("Error: " + text);
              return;
            }

            // Update the field value and reset the buttons
            fieldValueDiv.textContent = newValue;
            confirmBtn.classList.add("hidden");
            cancelBtn.classList.add("hidden");
            editBtn.classList.remove("hidden");
            editingField = null;
          });

          cancelBtn.addEventListener("click", () => {
            // Revert to old value
            fieldValueDiv.textContent = oldValue;
            // Hide confirm and cancel buttons and show edit button
            confirmBtn.classList.add("hidden");
            cancelBtn.classList.add("hidden");
            editBtn.classList.remove("hidden");
            editingField = null;
          });
        });
      });
    </script>
  </head>
  <body>
    {% include "navbar.html" %}

    <div class="container mx-auto px-4 py-6">
      <h1 class="text-4xl font-bold text-brand text-center mb-8">
        ðŸ“¦ Inventory
      </h1>

      <div class="bg-white shadow-lg rounded-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Manage Inventory</h2>
        <div class="flex flex-wrap gap-4">
          <a
            class="bg-brand hover:bg-brandDark text-white font-semibold py-2 px-4 rounded-lg shadow"
          >
            âž• Add New Items
          </a>
          <a
            class="bg-brand hover:bg-brandDark text-white font-semibold py-2 px-4 rounded-lg shadow"
          >
            ðŸ”¢ Count
          </a>
        </div>
      </div>

      <div class="bg-white shadow-lg rounded-lg p-6">
        <h2 class="text-2xl font-semibold mb-4">Current Stock</h2>
        <div class="mb-6">{% include "filter.html" %}</div>

        <div class="overflow-x-auto">
          <table class="min-w-full border border-gray-200 rounded-lg">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2 text-left">Item ID</th>
                <th class="px-4 py-2 text-left">Title</th>
                <th class="px-4 py-2 text-left">Category</th>
                <th class="px-4 py-2 text-left">Stock</th>
                <th class="px-4 py-2 text-left">Max Stock</th>
                <th class="px-4 py-2 text-left">Description</th>
                <th class="px-4 py-2 text-left">Image Path</th>
              </tr>
            </thead>
            <tbody>
              {% for item in inventory %}
              <tr class="border-t hover:bg-gray-50">
                {% for field in
                ["itemId","title","category","stock","max_stock","description","img"]
                %}
                <td class="px-4 py-2">
                  <div
                    class="relative group"
                    data-item="{{ item.itemId }}"
                    data-field="{{ field }}"
                  >
                    <!-- Field data -->
                    <div class="field-value">{{ item[field] }}</div>
                    <!-- Edit button (shown on hover) -->
                    <div
                      class="absolute right-0 top-0 text-white text-xs flex items-center"
                    >
                      <div
                        class="edit-btn opacity-0 group-hover:opacity-100 bg-accent1 text-white text-xs px-1 py-0.5 rounded cursor-pointer flex items-center"
                      >
                        <span class="material-symbols-outlined">edit</span>
                        <span>Edit</span>
                      </div>
                      <div
                        class="confirm-btn hidden bg-limeGreen text-white text-xs px-1 py-0.5 rounded cursor-pointer flex items-center mr-1"
                      >
                        <span class="material-symbols-outlined"
                          >check_circle</span
                        >
                      </div>
                      <div
                        class="cancel-btn hidden bg-brand text-white text-xs px-1 py-0.5 rounded cursor-pointer flex items-center"
                      >
                        <span class="material-symbols-outlined">cancel</span>
                      </div>
                    </div>
                  </div>
                </td>
                {% endfor %}
              </tr>
              {% else %}
              <tr>
                <td colspan="7" class="px-4 py-4 text-center text-gray-500">
                  No inventory items found.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </body>
</html>
